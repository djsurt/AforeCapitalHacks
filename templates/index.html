<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PodGen — AI Podcast Generator</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Background glows -->
    <div class="bg-glow bg-glow--1"></div>
    <div class="bg-glow bg-glow--2"></div>

    <div class="app">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="brand">
                <div class="brand-icon">
                    <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                        <line x1="12" y1="19" x2="12" y2="23"/>
                        <line x1="8" y1="23" x2="16" y2="23"/>
                    </svg>
                </div>
                <span class="brand-name">PodGen</span>
            </div>

            <nav class="sidebar-nav">
                <a href="#" class="nav-item active" data-view="generate">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></svg>
                    Generate
                </a>
                <a href="#" class="nav-item" data-view="history">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                    History
                </a>
            </nav>

            <div class="sidebar-footer">
                <div class="status-dot" id="healthDot"></div>
                <span class="status-text" id="healthText">Checking...</span>
            </div>
        </aside>

        <!-- Main content -->
        <main class="main">
            <!-- GENERATE VIEW -->
            <section id="generateView" class="view active">
                <div class="view-header">
                    <h1>Create a Podcast</h1>
                    <p>Enter a topic or paste a URL — AI generates a two-host episode in minutes.</p>
                </div>

                <form id="generateForm" class="gen-form">
                    <div class="form-row">
                        <div class="form-field form-field--grow">
                            <label for="topic">Topic</label>
                            <input type="text" id="topic" placeholder="e.g. black holes, the history of pizza...">
                        </div>
                        <div class="form-field form-field--tone">
                            <label for="tone">Tone</label>
                            <select id="tone">
                                <option value="casual" selected>Casual</option>
                                <option value="academic">Academic</option>
                                <option value="comedic">Comedic</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-field">
                        <label for="url">Or paste an article URL</label>
                        <input type="url" id="url" placeholder="https://example.com/interesting-article">
                    </div>
                    <button type="submit" id="submitBtn" class="btn-generate">
                        <svg class="btn-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                        <span class="btn-label">Generate Podcast</span>
                        <div class="btn-spinner"></div>
                    </button>
                </form>

                <!-- Progress -->
                <div id="progressSection" class="progress-section" hidden>
                    <div class="progress-header">
                        <span id="progressLabel">Starting...</span>
                    </div>
                    <div class="progress-steps">
                        <div class="step" data-step="research">
                            <div class="step-indicator"></div>
                            <span>Research</span>
                        </div>
                        <div class="step-line"></div>
                        <div class="step" data-step="script">
                            <div class="step-indicator"></div>
                            <span>Script</span>
                        </div>
                        <div class="step-line"></div>
                        <div class="step" data-step="voice">
                            <div class="step-indicator"></div>
                            <span>Voice</span>
                        </div>
                        <div class="step-line"></div>
                        <div class="step" data-step="stitch">
                            <div class="step-indicator"></div>
                            <span>Stitch</span>
                        </div>
                    </div>
                </div>

                <!-- Results -->
                <div id="resultsSection" class="results-section" hidden>
                    <!-- Player card -->
                    <div class="player-card">
                        <div class="player-top">
                            <div class="waveform" id="waveform"></div>
                        </div>
                        <div class="player-body">
                            <h2 id="podcastTitle" class="player-title">Your Podcast</h2>
                            <p id="podcastMeta" class="player-meta">Edward &amp; Adam</p>

                            <audio id="audioPlayer"></audio>

                            <div class="player-controls">
                                <button id="playBtn" class="btn-play" title="Play / Pause">
                                    <svg id="playIcon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><polygon points="6 3 20 12 6 21 6 3"/></svg>
                                    <svg id="pauseIcon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" hidden><rect x="6" y="4" width="4" height="16" rx="1"/><rect x="14" y="4" width="4" height="16" rx="1"/></svg>
                                </button>
                                <div class="player-timeline">
                                    <input type="range" id="seekBar" class="seek-bar" min="0" max="100" value="0" step="0.1">
                                    <div class="time-row">
                                        <span id="currentTime">0:00</span>
                                        <span id="duration">0:00</span>
                                    </div>
                                </div>
                                <a id="downloadBtn" class="btn-icon-circle" title="Download MP3" download>
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                </a>
                            </div>

                            <div id="noAudioNote" class="no-audio-note" hidden>
                                No audio clips generated — check your ElevenLabs key. Script is below.
                            </div>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="tabs">
                        <button class="tab active" data-tab="transcript">Transcript</button>
                        <button class="tab" data-tab="research">Research</button>
                    </div>

                    <div class="tab-panel" id="transcriptTab">
                        <div id="transcript" class="transcript"></div>
                    </div>
                    <div class="tab-panel" id="researchTab" hidden>
                        <pre id="researchBrief" class="research-brief"></pre>
                    </div>
                </div>

                <!-- Error -->
                <div id="errorSection" class="error-section" hidden>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>
                    <p id="errorText"></p>
                </div>
            </section>

            <!-- HISTORY VIEW -->
            <section id="historyView" class="view">
                <div class="view-header">
                    <h1>History</h1>
                    <p>Previously generated podcasts from this session.</p>
                </div>
                <div id="historyList" class="history-list">
                    <div class="history-empty">No podcasts generated yet. Go create one!</div>
                </div>
            </section>
        </main>
    </div>

    <script>
    (() => {
        // --- DOM refs ---
        const form = document.getElementById('generateForm');
        const submitBtn = document.getElementById('submitBtn');
        const progressSection = document.getElementById('progressSection');
        const progressLabel = document.getElementById('progressLabel');
        const resultsSection = document.getElementById('resultsSection');
        const errorSection = document.getElementById('errorSection');
        const errorText = document.getElementById('errorText');
        const audioPlayer = document.getElementById('audioPlayer');
        const playBtn = document.getElementById('playBtn');
        const playIcon = document.getElementById('playIcon');
        const pauseIcon = document.getElementById('pauseIcon');
        const seekBar = document.getElementById('seekBar');
        const currentTimeEl = document.getElementById('currentTime');
        const durationEl = document.getElementById('duration');
        const downloadBtn = document.getElementById('downloadBtn');
        const noAudioNote = document.getElementById('noAudioNote');
        const waveform = document.getElementById('waveform');

        const sessionHistory = [];

        // --- Health check ---
        (async () => {
            try {
                const r = await fetch('/health');
                const d = await r.json();
                const dot = document.getElementById('healthDot');
                const txt = document.getElementById('healthText');
                const allGood = Object.values(d.keys_configured).every(v => v);
                dot.classList.add(allGood ? 'green' : 'yellow');
                txt.textContent = allGood ? 'All systems go' : 'Some keys missing';
            } catch {
                document.getElementById('healthDot').classList.add('red');
                document.getElementById('healthText').textContent = 'Server unreachable';
            }
        })();

        // --- Waveform bars ---
        for (let i = 0; i < 48; i++) {
            const bar = document.createElement('div');
            bar.className = 'waveform-bar';
            bar.style.animationDelay = (Math.random() * 2).toFixed(2) + 's';
            bar.style.height = (Math.random() * 50 + 15) + '%';
            waveform.appendChild(bar);
        }

        // --- Sidebar nav ---
        document.querySelectorAll('.nav-item').forEach(a => {
            a.addEventListener('click', e => {
                e.preventDefault();
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                a.classList.add('active');
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                document.getElementById(a.dataset.view + 'View').classList.add('active');
            });
        });

        // --- Tabs ---
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                document.querySelectorAll('.tab-panel').forEach(p => p.hidden = true);
                document.getElementById(tab.dataset.tab + 'Tab').hidden = false;
            });
        });

        // --- Audio controls ---
        playBtn.addEventListener('click', () => {
            if (audioPlayer.paused) audioPlayer.play();
            else audioPlayer.pause();
        });
        audioPlayer.addEventListener('play', () => { playIcon.hidden = true; pauseIcon.hidden = false; waveform.classList.add('playing'); });
        audioPlayer.addEventListener('pause', () => { playIcon.hidden = false; pauseIcon.hidden = true; waveform.classList.remove('playing'); });
        audioPlayer.addEventListener('ended', () => { playIcon.hidden = false; pauseIcon.hidden = true; waveform.classList.remove('playing'); seekBar.value = 0; });
        audioPlayer.addEventListener('timeupdate', () => {
            if (audioPlayer.duration) {
                seekBar.value = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                currentTimeEl.textContent = fmtTime(audioPlayer.currentTime);
            }
        });
        audioPlayer.addEventListener('loadedmetadata', () => { durationEl.textContent = fmtTime(audioPlayer.duration); });
        seekBar.addEventListener('input', () => {
            if (audioPlayer.duration) audioPlayer.currentTime = (seekBar.value / 100) * audioPlayer.duration;
        });

        function fmtTime(s) {
            const m = Math.floor(s / 60);
            return m + ':' + String(Math.floor(s % 60)).padStart(2, '0');
        }

        // --- Progress stepper ---
        const phases = [
            { step: 'research', label: 'Researching your topic...', delay: 0 },
            { step: 'script',   label: 'Writing the script...', delay: 3000 },
            { step: 'voice',    label: 'Generating voice clips...', delay: 10000 },
            { step: 'stitch',   label: 'Stitching final audio...', delay: 45000 },
        ];
        let stepTimers = [];

        function startProgress() {
            document.querySelectorAll('.step').forEach(s => s.className = 'step');
            document.querySelectorAll('.step-line').forEach(l => l.classList.remove('done'));
            stepTimers.forEach(t => clearTimeout(t));
            stepTimers = [];
            phases.forEach(({ step, label, delay }) => {
                stepTimers.push(setTimeout(() => {
                    progressLabel.textContent = label;
                    const allSteps = [...document.querySelectorAll('.step')];
                    const allLines = [...document.querySelectorAll('.step-line')];
                    const el = document.querySelector(`.step[data-step="${step}"]`);
                    const idx = allSteps.indexOf(el);
                    allSteps.forEach((s, i) => {
                        s.classList.remove('active');
                        if (i < idx) s.classList.add('done');
                        else s.classList.remove('done');
                    });
                    allLines.forEach((l, i) => { if (i < idx) l.classList.add('done'); else l.classList.remove('done'); });
                    el.classList.add('active');
                }, delay));
            });
        }

        function stopProgress() {
            stepTimers.forEach(t => clearTimeout(t));
            document.querySelectorAll('.step').forEach(s => { s.classList.remove('active'); s.classList.add('done'); });
            document.querySelectorAll('.step-line').forEach(l => l.classList.add('done'));
            progressLabel.textContent = 'Done!';
        }

        // --- Generate ---
        form.addEventListener('submit', async e => {
            e.preventDefault();
            const topic = document.getElementById('topic').value.trim();
            const url = document.getElementById('url').value.trim();
            const tone = document.getElementById('tone').value;

            if (!topic && !url) { showError('Enter a topic or paste a URL.'); return; }

            submitBtn.disabled = true;
            submitBtn.classList.add('loading');
            progressSection.hidden = false;
            resultsSection.hidden = true;
            errorSection.hidden = true;
            startProgress();

            try {
                const resp = await fetch('/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic, url, tone }),
                });
                if (!resp.ok) { const e = await resp.json(); throw new Error(e.detail || 'Generation failed'); }
                const data = await resp.json();
                stopProgress();
                setTimeout(() => { progressSection.hidden = true; showResults(data, topic || url); }, 700);
            } catch (err) {
                showError(err.message);
                progressSection.hidden = true;
            } finally {
                submitBtn.disabled = false;
                submitBtn.classList.remove('loading');
            }
        });

        function showError(msg) {
            errorText.textContent = msg;
            errorSection.hidden = false;
        }

        function showResults(data) {
            resultsSection.hidden = false;
            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

            document.getElementById('podcastTitle').textContent = data.topic || 'Podcast';
            document.getElementById('podcastMeta').textContent = `${data.clip_count || 0} clips · ${data.tone} tone · Job ${data.job_id}`;

            if (data.has_audio && data.audio_url) {
                audioPlayer.src = data.audio_url;
                downloadBtn.href = data.audio_url;
                downloadBtn.hidden = false;
                noAudioNote.hidden = true;
                playBtn.disabled = false;
            } else {
                downloadBtn.hidden = true;
                noAudioNote.hidden = false;
                playBtn.disabled = true;
            }

            // Transcript
            const el = document.getElementById('transcript');
            el.innerHTML = '';
            if (data.script && data.script.length) {
                data.script.forEach((line, i) => {
                    const d = document.createElement('div');
                    d.className = 'line ' + line.speaker.toLowerCase();
                    d.style.animationDelay = (i * 0.04) + 's';
                    d.innerHTML = `<div class="line-avatar">${line.speaker[0]}</div><div class="line-body"><div class="line-speaker">${esc(line.speaker)}</div><div class="line-text">${esc(line.text)}</div></div>`;
                    el.appendChild(d);
                });
            }

            document.getElementById('researchBrief').textContent = data.research_brief || 'No research data.';

            // History
            sessionHistory.unshift(data);
            renderHistory();
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            if (!sessionHistory.length) { list.innerHTML = '<div class="history-empty">No podcasts yet.</div>'; return; }
            list.innerHTML = sessionHistory.map(h => `
                <div class="history-item">
                    <div class="history-icon"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/></svg></div>
                    <div class="history-info">
                        <div class="history-title">${esc(h.topic)}</div>
                        <div class="history-sub">${h.clip_count || 0} clips · ${h.tone}</div>
                    </div>
                    ${h.audio_url ? `<a href="${h.audio_url}" class="btn-icon-circle small" download title="Download"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></a>` : ''}
                </div>
            `).join('');
        }

        function esc(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
    })();
    </script>
</body>
</html>
